<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>SLURMM Group Dependency Graph</title>

  <!-- Bootstrap 5 CSS (for modal + spinner) -->
  <link
    href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
    rel="stylesheet"
  />

  <style>
    html, body { height:100%; margin:0; padding:0; }
    #cy { width:100%; height:100%; display:block; }

    /* Loader overlay */
    #loader {
      position: fixed;
      top:0; left:0; right:0; bottom:0;
      background: rgba(255,255,255,0.8);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 999;
    }
  </style>
</head>
<body>

  <!-- Loader -->
  <div id="loader">
    <div class="spinner-border text-primary" role="status" style="width: 4rem; height:4rem;">
      <span class="visually-hidden">Loading...</span>
    </div>
  </div>

  <!-- Graph container -->
  <div id="cy"></div>

  <!-- Bootstrap Modal -->
  <div
    class="modal fade"
    id="jobModal"
    tabindex="-1"
    aria-labelledby="jobModalLabel"
    aria-hidden="true"
  >
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="jobModalLabel">Group Jobs</h5>
          <button
            type="button"
            class="btn-close"
            data-bs-dismiss="modal"
            aria-label="Close"
          ></button>
        </div>
        <div class="modal-body">
          <ul id="modalList" class="list-group"></ul>
        </div>
      </div>
    </div>
  </div>

  <!-- Cytoscape.js -->
  <script src="https://unpkg.com/cytoscape@3.24.0/dist/cytoscape.min.js"></script>
  <!-- Bootstrap JS bundle (includes Popper) -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

  <script>
  (async () => {
    const loader = document.getElementById('loader');

    try {
      // 1) Show loader
      loader.style.display = 'flex';

      // 2) Fetch the wrapper JSON from your API
      const resp = await fetch(`/api/jobs?format=json${window.location.search}`);
      const data = await resp.json();
      const jobs = data.jobs || [];

      // 3) Group jobs and collect edges
      const groups = {}, edges = [];
      jobs.forEach(j => (groups[j.group_name] ||= []).push(j));
      jobs.forEach(j => {
        (j.depends_on || []).forEach(dep => {
          const p = jobs.find(x=>x.job_id.toString()===dep);
          if (p && p.group_name!==j.group_name) {
            edges.push({ source: p.group_name, target: j.group_name });
          }
        });
      });

      // 4) smartRangeDisplay
      function smartRangeDisplay(ids) {
        ids = ids.map(i=>+i).sort((a,b)=>a-b);
        if(ids.length===1) return `${ids[0]}`;
        if(ids.length<=3) return ids.join(",");
        const cont = ids.every((v,i)=>i===0||v===ids[i-1]+1);
        if(cont) return `${ids[0]}-${ids[ids.length-1]} (${ids.length})`;
        return `${ids[0]}...${ids[ids.length-1]} (${ids.length})`;
      }

      // 5) Build Cytoscape elements
      const elements = [
        ...Object.entries(groups).map(([name, arr]) => {
          const total     = arr.length;
          const completed = arr.filter(j=>j.status==="COMPLETED").length;
          const pct       = Math.round((completed/total)*100);
          const idLabel   = smartRangeDisplay(arr.map(j=>j.job_id));
          const label     = `${idLabel}\n${completed}/${total} (${pct}%)`;
          return { data: { id: name, label } };
        }),
        ...edges.map(e => ({ data: e }))
      ];

      // 6) Initialize Cytoscape
      const cy = cytoscape({
        container: document.getElementById('cy'),
        elements,
        style: [
          {
            selector: 'node',
            style: {
              'label':         'data(label)',
              'text-wrap':     'wrap',
              'text-valign':   'center',
              'text-halign':   'center',
              'background-color':'#42a5f5',
              'color':         '#fff',
              'width':         'label',
              'height':        'label',
              'padding':       '6px',
              'border-width':  2,
              'border-color':  '#1976d2',
              'font-size':     12
            }
          },
          {
            selector: 'node:hover',
            style: {
              'background-color': '#ffa726'
            }
          },
          {
            selector: 'edge',
            style: {
              'line-color':         '#999',
              'width':              2,
              'target-arrow-shape': 'triangle',
              'target-arrow-color': '#999',
              'curve-style':        'bezier'
            }
          }
        ],
        layout: { name:'breadthfirst', directed:true, padding:20 }
      });

      // 7) Bootstrap modal hookup
      const modalEl = document.getElementById('jobModal');
      const bsModal = new bootstrap.Modal(modalEl);

      cy.on('tap','node', evt => {
        const grp  = evt.target.id();
        const list = document.getElementById('modalList');
        document.getElementById('jobModalLabel').textContent = `Group: ${grp}`;
        list.innerHTML = '';
        (groups[grp]||[]).forEach(job => {
          const li = document.createElement('li');
          li.className = 'list-group-item';
          li.innerHTML = `<strong>#${job.job_id}</strong> [${job.status}]<br><code>${job.command}</code>`;
          list.appendChild(li);
        });
        bsModal.show();
      });

      // hide modal on background tap
      cy.on('tap', evt => {
        if(evt.target===cy && bsModal._isShown) bsModal.hide();
      });

    } finally {
      // 8) Hide loader
      loader.style.display = 'none';
    }
  })();
  </script>
</body>
</html>
