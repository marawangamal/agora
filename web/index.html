<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>SLURM Dependency Graph</title>
<style>
    :root {
        /* Light theme colors */
        --bg-primary: #f9fafb;
        --bg-secondary: #ffffff;
        --bg-tertiary: #fafafa;
        --bg-quaternary: #f3f4f6;
        --text-primary: #111827;
        --text-secondary: #6b7280;
        --text-tertiary: #9ca3af;
        --border-primary: #e5e7eb;
        --border-secondary: #d1d5db;
        --shadow-primary: rgba(0, 0, 0, 0.1);
        --shadow-secondary: rgba(0, 0, 0, 0.05);
        --overlay: rgba(0, 0, 0, 0.5);
        
        /* Status colors (same for both themes) */
        --status-running: #3b82f6;
        --status-completed: #10b981;
        --status-failed: #ef4444;
        --status-pending: #f59e0b;
        --status-mixed: #d97706;
        
        /* Status backgrounds */
        --status-running-bg: #dbeafe;
        --status-completed-bg: #d1fae5;
        --status-failed-bg: #fee2e2;
        --status-pending-bg: #f3f4f6;
        
        /* Status text */
        --status-running-text: #1e40af;
        --status-completed-text: #065f46;
        --status-failed-text: #991b1b;
        --status-pending-text: #374151;
        
        /* Resource info */
        --resource-bg: #f0f9ff;
        --resource-border: #e0f2fe;
        --resource-label: #0369a1;
        --resource-value: #0c4a6e;
        
        /* Error info */
        --error-bg: #fef2f2;
        --error-border: #fecaca;
        --error-text: #dc2626;

        /* Filter colors */
        --filter-bg: #f8fafc;
        --filter-border: #e2e8f0;
        --filter-active: #3b82f6;
        --filter-active-bg: #eff6ff;

        /* Log viewer colors */
        --log-bg: #1a1a1a;
        --log-text: #e5e5e5;
        --log-border: #333333;
        --log-scrollbar: #555555;
        --log-scrollbar-thumb: #777777;
    }

    [data-theme="dark"] {
        /* Dark theme colors */
        --bg-primary: #111827;
        --bg-secondary: #1f2937;
        --bg-tertiary: #374151;
        --bg-quaternary: #4b5563;
        --text-primary: #f9fafb;
        --text-secondary: #d1d5db;
        --text-tertiary: #9ca3af;
        --border-primary: #374151;
        --border-secondary: #4b5563;
        --shadow-primary: rgba(0, 0, 0, 0.3);
        --shadow-secondary: rgba(0, 0, 0, 0.2);
        --overlay: rgba(0, 0, 0, 0.7);
        
        /* Status backgrounds (darker) */
        --status-running-bg: #1e3a8a;
        --status-completed-bg: #064e3b;
        --status-failed-bg: #7f1d1d;
        --status-pending-bg: #374151;
        
        /* Status text (lighter) */
        --status-running-text: #93c5fd;
        --status-completed-text: #6ee7b7;
        --status-failed-text: #fca5a5;
        --status-pending-text: #d1d5db;
        
        /* Resource info (darker) */
        --resource-bg: #1e3a8a;
        --resource-border: #1d4ed8;
        --resource-label: #93c5fd;
        --resource-value: #dbeafe;
        
        /* Error info (darker) */
        --error-bg: #7f1d1d;
        --error-border: #dc2626;
        --error-text: #fca5a5;

        /* Filter colors (darker) */
        --filter-bg: #1f2937;
        --filter-border: #374151;
        --filter-active: #60a5fa;
        --filter-active-bg: #1e3a8a;

        /* Log viewer colors (darker) */
        --log-bg: #0f0f0f;
        --log-text: #e5e5e5;
        --log-border: #2a2a2a;
        --log-scrollbar: #444444;
        --log-scrollbar-thumb: #666666;
    }

    * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
    }

    body {
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        background-color: var(--bg-primary);
        color: var(--text-primary);
        padding: 20px;
        transition: background-color 0.3s ease, color 0.3s ease;
    }

    .container {
        max-width: 1400px;
        margin: 0 auto;
    }

    .header {
        margin-bottom: 20px;
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
    }

    .header-content h1 {
        font-size: 28px;
        font-weight: bold;
        margin-bottom: 4px;
        color: var(--text-primary);
        display: flex;
        align-items: center;
        gap: 12px;
    }

    .header-content .subtitle {
        color: var(--text-secondary);
        font-size: 14px;
        margin-bottom: 8px;
    }

    .copyright {
        font-size: 12px;
        color: var(--text-tertiary);
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .copyright a {
        color: var(--status-running);
        text-decoration: none;
    }

    .copyright a:hover {
        text-decoration: underline;
    }

    .header-controls {
        display: flex;
        align-items: center;
        gap: 12px;
    }

    .theme-toggle {
        background: var(--bg-secondary);
        border: 1px solid var(--border-primary);
        border-radius: 8px;
        padding: 8px 12px;
        cursor: pointer;
        font-size: 14px;
        color: var(--text-primary);
        transition: all 0.2s ease;
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .theme-toggle:hover {
        background: var(--bg-quaternary);
        border-color: var(--border-secondary);
    }

    .main-content {
        display: grid;
        grid-template-columns: 300px 1fr;
        gap: 20px;
        height: 600px;
    }

    .filters-panel {
        background: var(--bg-secondary);
        border: 1px solid var(--border-primary);
        border-radius: 8px;
        padding: 20px;
        overflow-y: auto;
        transition: all 0.3s ease;
    }

    .filters-title {
        font-size: 18px;
        font-weight: 600;
        margin-bottom: 16px;
        color: var(--text-primary);
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .filter-section {
        margin-bottom: 20px;
    }

    .filter-section:last-child {
        margin-bottom: 0;
    }

    .filter-label {
        font-size: 14px;
        font-weight: 500;
        color: var(--text-primary);
        margin-bottom: 8px;
        display: block;
    }

    .search-input {
        width: 100%;
        padding: 8px 12px;
        border: 1px solid var(--border-primary);
        border-radius: 6px;
        background: var(--bg-primary);
        color: var(--text-primary);
        font-size: 14px;
        transition: all 0.2s ease;
    }

    .search-input:focus {
        outline: none;
        border-color: var(--filter-active);
        box-shadow: 0 0 0 3px var(--filter-active-bg);
    }

    .filter-chips {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
    }

    .filter-chip {
        padding: 6px 12px;
        border: 1px solid var(--border-primary);
        border-radius: 16px;
        background: var(--bg-primary);
        color: var(--text-secondary);
        font-size: 12px;
        cursor: pointer;
        transition: all 0.2s ease;
        user-select: none;
    }

    .filter-chip:hover {
        border-color: var(--filter-active);
        color: var(--filter-active);
    }

    .filter-chip.active {
        background: var(--filter-active);
        border-color: var(--filter-active);
        color: white;
    }

    .filter-stats {
        margin-top: 16px;
        padding: 12px;
        background: var(--filter-bg);
        border: 1px solid var(--filter-border);
        border-radius: 6px;
        font-size: 12px;
        color: var(--text-secondary);
    }

    .filter-stats-item {
        display: flex;
        justify-content: space-between;
        margin-bottom: 4px;
    }

    .filter-stats-item:last-child {
        margin-bottom: 0;
    }

    .clear-filters {
        width: 100%;
        padding: 8px 12px;
        background: var(--bg-quaternary);
        border: 1px solid var(--border-primary);
        border-radius: 6px;
        color: var(--text-primary);
        font-size: 12px;
        cursor: pointer;
        transition: all 0.2s ease;
        margin-top: 12px;
    }

    .clear-filters:hover {
        background: var(--border-primary);
    }

    .clear-filters:disabled {
        opacity: 0.5;
        cursor: not-allowed;
    }

    .graph-container {
        position: relative;
        width: 100%;
        height: 100%;
        background: var(--bg-secondary);
        border: 1px solid var(--border-primary);
        border-radius: 8px;
        overflow: hidden;
        transition: background-color 0.3s ease, border-color 0.3s ease;
    }

    .graph-controls {
        position: absolute;
        top: 16px;
        right: 16px;
        z-index: 10;
        display: flex;
        flex-direction: column;
        gap: 8px;
        background: var(--bg-secondary);
        border: 1px solid var(--border-primary);
        border-radius: 8px;
        padding: 8px;
        box-shadow: 0 4px 6px var(--shadow-primary);
        transition: all 0.3s ease;
    }

    .graph-controls button {
        padding: 4px 8px;
        border: none;
        border-radius: 4px;
        background: var(--bg-quaternary);
        cursor: pointer;
        font-size: 14px;
        min-width: 40px;
        color: var(--text-primary);
        transition: all 0.2s ease;
    }

    .graph-controls button:hover {
        background: var(--border-primary);
    }

    .reset-btn {
        background: var(--status-running-bg) !important;
        color: var(--status-running-text) !important;
        font-size: 12px !important;
    }

    .refresh-btn {
        background: var(--status-completed) !important;
        color: white !important;
        font-size: 12px !important;
    }

    .graph-info {
        position: absolute;
        bottom: 16px;
        left: 16px;
        background: var(--bg-secondary);
        border: 1px solid var(--border-primary);
        border-radius: 6px;
        padding: 8px 12px;
        font-size: 12px;
        color: var(--text-secondary);
        box-shadow: 0 2px 4px var(--shadow-secondary);
    }

    .loading-indicator {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background: var(--bg-secondary);
        padding: 20px;
        border-radius: 8px;
        box-shadow: 0 4px 6px var(--shadow-primary);
        display: none;
        z-index: 20;
        color: var(--text-primary);
        transition: all 0.3s ease;
    }

    .loading-indicator.show {
        display: block;
    }

    .error-indicator {
        position: absolute;
        top: 16px;
        left: 16px;
        background: var(--error-bg);
        color: var(--error-text);
        padding: 8px 12px;
        border-radius: 6px;
        font-size: 12px;
        display: none;
        z-index: 20;
        border: 1px solid var(--error-border);
        transition: all 0.3s ease;
    }

    .error-indicator.show {
        display: block;
    }

    #cy {
        width: 100%;
        height: 100%;
    }

    .fallback-message {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        text-align: center;
        color: var(--text-secondary);
        display: none;
    }

    .fallback-message.show {
        display: block;
    }

    /* Simplified Tooltip Styles */
    .tooltip {
        position: absolute;
        background: var(--bg-secondary);
        border: 1px solid var(--border-primary);
        border-radius: 6px;
        padding: 8px 12px;
        box-shadow: 0 4px 6px var(--shadow-primary);
        font-size: 12px;
        max-width: 200px;
        z-index: 1000;
        pointer-events: none;
        opacity: 0;
        transition: opacity 0.2s ease;
    }

    .tooltip.show {
        opacity: 1;
    }

    .tooltip-header {
        font-weight: 600;
        margin-bottom: 6px;
        color: var(--text-primary);
        font-size: 13px;
    }

    .tooltip-breakdown {
        font-size: 11px;
        color: var(--text-secondary);
        line-height: 1.4;
    }

    /* Modal Styles */
    .modal {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: var(--overlay);
        display: none;
        align-items: center;
        justify-content: center;
        z-index: 1000;
        transition: background-color 0.3s ease;
    }

    .modal.show {
        display: flex;
    }

    .modal-content {
        background: var(--bg-secondary);
        border-radius: 12px;
        box-shadow: 0 20px 25px var(--shadow-primary);
        max-width: 800px;
        max-height: 80vh;
        width: 90%;
        overflow: hidden;
        animation: modalSlideIn 0.2s ease-out;
        transition: background-color 0.3s ease;
    }

    @keyframes modalSlideIn {
        from {
            opacity: 0;
            transform: scale(0.95) translateY(-20px);
        }
        to {
            opacity: 1;
            transform: scale(1) translateY(0);
        }
    }

    .modal-header {
        padding: 24px 24px 16px 24px;
        border-bottom: 1px solid var(--border-primary);
        display: flex;
        align-items: flex-start;
        justify-content: space-between;
        transition: border-color 0.3s ease;
    }

    .modal-title {
        font-size: 20px;
        font-weight: 600;
        color: var(--text-primary);
        margin-bottom: 4px;
    }

    .modal-subtitle {
        font-size: 14px;
        color: var(--text-secondary);
        display: flex;
        align-items: center;
        gap: 16px;
    }

    .modal-stats {
        display: flex;
        gap: 16px;
        margin-top: 8px;
    }

    .stat-item {
        display: flex;
        align-items: center;
        gap: 4px;
        font-size: 12px;
        color: var(--text-secondary);
    }

    .stat-value {
        font-weight: 600;
        color: var(--text-primary);
    }

    .close-btn {
        background: none;
        border: none;
        font-size: 24px;
        cursor: pointer;
        color: var(--text-tertiary);
        padding: 4px;
        border-radius: 4px;
        line-height: 1;
        transition: all 0.2s ease;
    }

    .close-btn:hover {
        color: var(--text-secondary);
        background: var(--bg-quaternary);
    }

    .modal-body {
        padding: 16px 24px 24px 24px;
        overflow-y: auto;
        max-height: 60vh;
    }

    .job-grid {
        display: grid;
        gap: 12px;
    }

    .job-card {
        border: 1px solid var(--border-primary);
        border-radius: 8px;
        padding: 16px;
        transition: all 0.2s;
        background: var(--bg-tertiary);
    }

    .job-card:hover {
        background: var(--bg-quaternary);
        border-color: var(--border-secondary);
        transform: translateY(-1px);
        box-shadow: 0 4px 6px var(--shadow-secondary);
    }

    .job-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-bottom: 12px;
    }

    .job-id {
        font-family: monospace;
        font-weight: 600;
        font-size: 16px;
        color: var(--text-primary);
    }

    .job-status {
        display: inline-flex;
        align-items: center;
        gap: 4px;
        padding: 4px 8px;
        border-radius: 6px;
        font-size: 12px;
        font-weight: 500;
    }

    .job-command {
        font-family: monospace;
        background: var(--bg-quaternary);
        padding: 8px 12px;
        border-radius: 6px;
        font-size: 13px;
        color: var(--text-primary);
        margin-bottom: 12px;
        border-left: 3px solid var(--border-secondary);
        word-break: break-all;
        transition: all 0.3s ease;
        line-height: 1.4;
    }

    .job-details {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 12px;
        font-size: 13px;
    }

    .job-detail-item {
        display: flex;
        flex-direction: column;
        gap: 2px;
    }

    .job-detail-label {
        color: var(--text-secondary);
        font-weight: 500;
        font-size: 11px;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    .job-detail-value {
        color: var(--text-primary);
    }

    .dependency-list {
        display: flex;
        flex-wrap: wrap;
        gap: 4px;
    }

    .dependency-tag {
        background: var(--status-running-bg);
        color: var(--status-running-text);
        padding: 2px 6px;
        border-radius: 4px;
        font-size: 11px;
        font-family: monospace;
        font-weight: 500;
    }

    .resource-info {
        background: var(--resource-bg);
        border: 1px solid var(--resource-border);
        border-radius: 6px;
        padding: 8px;
        margin-top: 8px;
        transition: all 0.3s ease;
    }

    .resource-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        font-size: 12px;
        margin-bottom: 4px;
    }

    .resource-item:last-child {
        margin-bottom: 0;
    }

    .resource-label {
        color: var(--resource-label);
        font-weight: 500;
    }

    .resource-value {
        color: var(--resource-value);
        font-family: monospace;
    }

    .progress-bar {
        width: 100%;
        height: 6px;
        background: var(--border-primary);
        border-radius: 3px;
        overflow: hidden;
        margin-top: 4px;
        transition: background-color 0.3s ease;
    }

    .progress-fill {
        height: 100%;
        background: linear-gradient(90deg, var(--status-running), #1d4ed8);
        transition: width 0.3s ease;
    }

    .status-running { 
        background: var(--status-running-bg); 
        color: var(--status-running-text); 
    }
    .status-completed { 
        background: var(--status-completed-bg); 
        color: var(--status-completed-text); 
    }
    .status-failed { 
        background: var(--status-failed-bg); 
        color: var(--status-failed-text); 
    }
    .status-pending { 
        background: var(--status-pending-bg); 
        color: var(--status-pending-text); 
    }
    .status-mixed { 
        background: linear-gradient(135deg, #fbbf24, #f59e0b, #d97706); 
        color: white; 
    }

    .status-icon {
        width: 12px;
        height: 12px;
        border-radius: 50%;
        display: inline-block;
    }

    .icon-running { background: var(--status-running); }
    .icon-completed { background: var(--status-completed); }
    .icon-failed { background: var(--status-failed); }
    .icon-pending { background: var(--status-pending); }
    .icon-mixed { background: linear-gradient(135deg, #fbbf24, #f59e0b, #d97706); }

    /* Error info specific styling */
    .error-info {
        background: var(--error-bg) !important;
        border-color: var(--error-border) !important;
    }

    .error-info .resource-label {
        color: var(--error-text) !important;
    }

    .error-info .resource-value {
        color: var(--error-text) !important;
    }

    /* Log Viewer Styles */
    .log-viewer-btn {
        background: var(--status-pending) !important;
        color: white !important;
        font-size: 11px !important;
        padding: 4px 8px !important;
        margin-top: 8px;
        border-radius: 4px;
        border: none;
        cursor: pointer;
        transition: all 0.2s ease;
    }

    .log-viewer-btn:hover {
        background: #d97706 !important;
    }

    .log-modal {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: var(--overlay);
        display: none;
        align-items: center;
        justify-content: center;
        z-index: 1001;
        transition: background-color 0.3s ease;
    }

    .log-modal.show {
        display: flex;
    }

    .log-modal-content {
        background: var(--bg-secondary);
        border-radius: 12px;
        box-shadow: 0 20px 25px var(--shadow-primary);
        max-width: 90vw;
        max-height: 90vh;
        width: 1000px;
        height: 700px;
        overflow: hidden;
        animation: modalSlideIn 0.2s ease-out;
        transition: background-color 0.3s ease;
        display: flex;
        flex-direction: column;
    }

    .log-modal-header {
        padding: 20px 24px 16px 24px;
        border-bottom: 1px solid var(--border-primary);
        display: flex;
        align-items: center;
        justify-content: space-between;
        transition: border-color 0.3s ease;
        flex-shrink: 0;
    }

    .log-modal-title {
        font-size: 18px;
        font-weight: 600;
        color: var(--text-primary);
        font-family: monospace;
    }

    .log-controls {
        display: flex;
        align-items: center;
        gap: 12px;
    }

    .log-control-btn {
        padding: 6px 12px;
        border: 1px solid var(--border-primary);
        border-radius: 6px;
        background: var(--bg-quaternary);
        color: var(--text-primary);
        font-size: 12px;
        cursor: pointer;
        transition: all 0.2s ease;
    }

    .log-control-btn:hover {
        background: var(--border-primary);
    }

    .log-control-btn.active {
        background: var(--status-running);
        color: white;
        border-color: var(--status-running);
    }

    .log-viewer {
        flex: 1;
        background: var(--log-bg);
        color: var(--log-text);
        font-family: 'Courier New', monospace;
        font-size: 13px;
        line-height: 1.4;
        padding: 16px;
        overflow-y: auto;
        white-space: pre-wrap;
        word-wrap: break-word;
        border: none;
        outline: none;
        resize: none;
        transition: all 0.3s ease;
    }

    .log-viewer::-webkit-scrollbar {
        width: 12px;
    }

    .log-viewer::-webkit-scrollbar-track {
        background: var(--log-bg);
    }

    .log-viewer::-webkit-scrollbar-thumb {
        background: var(--log-scrollbar-thumb);
        border-radius: 6px;
    }

    .log-viewer::-webkit-scrollbar-thumb:hover {
        background: #888888;
    }

    .log-status {
        padding: 8px 16px;
        background: var(--bg-tertiary);
        border-top: 1px solid var(--border-primary);
        font-size: 12px;
        color: var(--text-secondary);
        display: flex;
        align-items: center;
        justify-content: space-between;
        flex-shrink: 0;
    }

    .log-status-indicator {
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .log-status-dot {
        width: 8px;
        height: 8px;
        border-radius: 50%;
        background: var(--status-pending);
    }

    .log-status-dot.connected {
        background: var(--status-completed);
        animation: pulse 2s infinite;
    }

    .log-status-dot.error {
        background: var(--status-failed);
    }

    @keyframes pulse {
        0% { opacity: 1; }
        50% { opacity: 0.5; }
        100% { opacity: 1; }
    }

    /* Responsive design */
    @media (max-width: 1200px) {
        .main-content {
            grid-template-columns: 250px 1fr;
        }
    }

    @media (max-width: 768px) {
        .main-content {
            grid-template-columns: 1fr;
            grid-template-rows: auto 1fr;
            height: auto;
        }
        
        .filters-panel {
            height: auto;
            max-height: 300px;
        }
        
        .graph-container {
            height: 500px;
        }
        
        .header {
            flex-direction: column;
            gap: 12px;
            align-items: flex-start;
        }
        
        .header-controls {
            align-self: flex-end;
        }

        .log-modal-content {
            width: 95vw;
            height: 85vh;
        }
    }

.log-buttons {
    display: flex;
    gap: 8px;
    margin-top: 8px;
    flex-wrap: wrap;
}

.log-viewer-btn.output-log {
    background: var(--status-running) !important;
    color: white !important;
}

.log-viewer-btn.error-log {
    background: var(--status-failed) !important;
    color: white !important;
}

.log-viewer-btn.output-log:hover {
    background: #2563eb !important;
}

.log-viewer-btn.error-log:hover {
    background: #dc2626 !important;
}

.tail-toggle-btn {
    padding: 8px 16px !important;
    border: 2px solid var(--border-primary) !important;
    border-radius: 8px !important;
    background: var(--bg-quaternary) !important;
    color: var(--text-primary) !important;
    font-size: 13px !important;
    font-weight: 600 !important;
    cursor: pointer;
    transition: all 0.3s ease !important;
    display: flex !important;
    align-items: center !important;
    gap: 8px !important;
    min-width: 120px !important;
    justify-content: center !important;
}

.tail-toggle-btn:hover {
    background: var(--border-primary) !important;
    transform: translateY(-1px) !important;
    box-shadow: 0 2px 4px var(--shadow-secondary) !important;
}

.tail-toggle-btn.active {
    background: var(--status-completed) !important;
    color: white !important;
    border-color: var(--status-completed) !important;
    box-shadow: 0 0 0 3px var(--status-completed-bg) !important;
}

.tail-toggle-btn.active:hover {
    background: #059669 !important;
    border-color: #059669 !important;
}

.tail-status-icon {
    width: 8px;
    height: 8px;
    border-radius: 50%;
    background: var(--status-pending);
    transition: all 0.3s ease;
}

.tail-toggle-btn.active .tail-status-icon {
    background: white;
    animation: pulse 2s infinite;
}
</style>
</head>
<body>
<div class="container">
    <div class="header">
        <div class="header-content">
            <h1>
                🔗 SLURM Dependency Graph
            </h1>
            <p class="subtitle">Professional dependency visualization with advanced filtering and live log viewing</p>
            <div class="copyright">
                <span>© 2024</span>
                <a href="https://github.com/marawangamal/jrun" target="_blank">SLURM Visualizer</a>
                <span>•</span>
                <span>Built with ❤️ for HPC workflows</span>
                <span>•</span>
                <a href="https://opensource.org/licenses/MIT" target="_blank">MIT License</a>
            </div>
        </div>
        <div class="header-controls">
            <button class="theme-toggle" onclick="toggleTheme()">
                <span id="theme-icon">🌙</span>
                <span id="theme-text">Dark</span>
            </button>
        </div>
    </div>

    <div class="main-content">
        <div class="filters-panel">
            <div class="filters-title">
                🔍 Filters & Search
            </div>
            
            <div class="filter-section">
                <label class="filter-label">Search Jobs</label>
                <input 
                    type="text" 
                    class="search-input" 
                    id="search-input"
                    placeholder="Search by job ID, command, or group..."
                    oninput="applyFilters()"
                >
            </div>

            <div class="filter-section">
                <label class="filter-label">Status</label>
                <div class="filter-chips" id="status-filters">
                    <div class="filter-chip" data-status="RUNNING" onclick="toggleStatusFilter('RUNNING')">
                        <span class="status-icon icon-running"></span> Running
                    </div>
                    <div class="filter-chip" data-status="COMPLETED" onclick="toggleStatusFilter('COMPLETED')">
                        <span class="status-icon icon-completed"></span> Completed
                    </div>
                    <div class="filter-chip" data-status="FAILED" onclick="toggleStatusFilter('FAILED')">
                        <span class="status-icon icon-failed"></span> Failed
                    </div>
                    <div class="filter-chip" data-status="PENDING" onclick="toggleStatusFilter('PENDING')">
                        <span class="status-icon icon-pending"></span> Pending
                    </div>
                </div>
            </div>

            <div class="filter-section">
                <label class="filter-label">Groups</label>
                <div class="filter-chips" id="group-filters">
                    <!-- Dynamically populated -->
                </div>
            </div>

            <div class="filter-section">
                <label class="filter-label">Dependencies</label>
                <div class="filter-chips">
                    <div class="filter-chip" data-dependency="has-deps" onclick="toggleDependencyFilter('has-deps')">
                        Has Dependencies
                    </div>
                    <div class="filter-chip" data-dependency="no-deps" onclick="toggleDependencyFilter('no-deps')">
                        No Dependencies
                    </div>
                    <div class="filter-chip" data-dependency="root" onclick="toggleDependencyFilter('root')">
                        Root Jobs
                    </div>
                </div>
            </div>

            <button class="clear-filters" onclick="clearAllFilters()" id="clear-filters-btn">
                Clear All Filters
            </button>

            <div class="filter-stats" id="filter-stats">
                <div class="filter-stats-item">
                    <span>Visible Groups:</span>
                    <span id="visible-groups">0</span>
                </div>
                <div class="filter-stats-item">
                    <span>Total Jobs:</span>
                    <span id="visible-jobs">0</span>
                </div>
                <div class="filter-stats-item">
                    <span>Filtered Out:</span>
                    <span id="filtered-jobs">0</span>
                </div>
            </div>
        </div>

        <div class="graph-container">
            <div class="loading-indicator" id="loading">
                <div>Loading jobs...</div>
            </div>
            
            <div class="error-indicator" id="error">
                Failed to load jobs. Using dummy data.
            </div>
            
            <div class="fallback-message" id="fallback">
                <div>Loading graph library...</div>
                <div style="margin-top: 8px; font-size: 12px;">If this persists, there may be a network issue.</div>
            </div>
            
            <div class="graph-controls">
                <button onclick="refreshJobs()" class="refresh-btn">↻</button>
                <button onclick="fitGraph()">Fit</button>
                <button onclick="zoomIn()">+</button>
                <button onclick="zoomOut()">-</button>
                <button class="reset-btn" onclick="resetView()">Reset</button>
            </div>

            <div class="graph-info" id="graph-info">
                Showing 0 groups • 0 jobs
            </div>
            
            <div id="cy"></div>
        </div>
    </div>
</div>

<!-- Simplified Tooltip -->
<div id="tooltip" class="tooltip"></div>

<!-- Enhanced Modal -->
<div id="modal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <div>
                <div class="modal-title" id="modal-title">Group Details</div>
                <div class="modal-subtitle" id="modal-subtitle"></div>
                <div class="modal-stats" id="modal-stats"></div>
            </div>
            <button class="close-btn" onclick="closeModal()">&times;</button>
        </div>
        <div class="modal-body">
            <div class="job-grid" id="job-grid"></div>
        </div>
    </div>
</div>

<!-- Log Viewer Modal -->
<div id="log-modal" class="log-modal">
    <div class="log-modal-content">
        <div class="log-modal-header">
            <div class="log-modal-title" id="log-modal-title">job.slurm_out</div>
            <div class="log-controls">
    <button class="tail-toggle-btn" id="tail-toggle-btn" onclick="toggleTailing()">
    <span class="tail-status-icon"></span>
    <span>Tail: OFF</span>
</button>
    <button class="close-btn" onclick="closeLogModal()">&times;</button>
</div>
        </div>
        <textarea class="log-viewer" id="log-viewer" readonly placeholder="Loading log file..."></textarea>
        <div class="log-status">
            <div class="log-status-indicator">
                <div class="log-status-dot" id="log-status-dot"></div>
                <span id="log-status-text">Disconnected</span>
            </div>
            <div id="log-info">
                <span id="log-lines">0 lines</span> • 
                <span id="log-size">0 bytes</span>
            </div>
        </div>
    </div>
</div>

<script>
    // Show fallback message initially
    document.getElementById('fallback').classList.add('show');

    // Theme management
    let currentTheme = 'light';

    function initTheme() {
        // Check for saved theme preference or default to 'light'
        const savedTheme = localStorage.getItem('theme') || 'light';
        currentTheme = savedTheme;
        document.documentElement.setAttribute('data-theme', currentTheme);
        updateThemeButton();
    }

    function toggleTheme() {
        currentTheme = currentTheme === 'light' ? 'dark' : 'light';
        document.documentElement.setAttribute('data-theme', currentTheme);
        localStorage.setItem('theme', currentTheme);
        updateThemeButton();
        
        // Re-render graph with new theme colors
        if (librariesLoaded && jobs.length > 0) {
            renderGraph();
        }
    }

    function updateThemeButton() {
        const themeIcon = document.getElementById('theme-icon');
        const themeText = document.getElementById('theme-text');
        
        if (currentTheme === 'dark') {
            themeIcon.textContent = '☀️';
            themeText.textContent = 'Light';
        } else {
            themeIcon.textContent = '🌙';
            themeText.textContent = 'Dark';
        }
    }

    function getThemeColors() {
        const root = document.documentElement;
        const style = getComputedStyle(root);
        
        return {
            bgPrimary: style.getPropertyValue('--bg-primary').trim(),
            bgSecondary: style.getPropertyValue('--bg-secondary').trim(),
            textPrimary: style.getPropertyValue('--text-primary').trim(),
            textSecondary: style.getPropertyValue('--text-secondary').trim(),
            borderPrimary: style.getPropertyValue('--border-primary').trim(),
            statusRunning: style.getPropertyValue('--status-running').trim(),
            statusCompleted: style.getPropertyValue('--status-completed').trim(),
            statusFailed: style.getPropertyValue('--status-failed').trim(),
            statusPending: style.getPropertyValue('--status-pending').trim()
        };
    }

    // Dummy job data for development
    const DUMMY_JOBS = [
        {
            job_id: 100001,
            command: "train.py --lr 1e-3 --model llama",
            group_name: "llama:sweep",
            depends_on: [],
            status: "COMPLETED",
            preamble: "#!/bin/bash\n#SBATCH --job-name=model-sweep\n#SBATCH --time=00:30:00\n#SBATCH --mem=2G",
            start_time: "2024-01-15 08:00:00",
            end_time: "2024-01-15 08:15:00",
            slurm_out: "/home/user/logs/job_100001.slurm_out",
            slurm_err: "/home/user/logs/job_100001.slurm_err"
        },
        {
            job_id: 100002,
            command: "train.py --lr 1e-4 --model llama",
            group_name: "llama:sweep",
            depends_on: [],
            status: "COMPLETED",
            preamble: "#!/bin/bash\n#SBATCH --job-name=model-sweep\n#SBATCH --time=00:30:00\n#SBATCH --mem=2G",
            start_time: "2024-01-15 08:00:00",
            end_time: "2024-01-15 08:15:00",
            slurm_out: "/home/user/logs/job_100002.slurm_out",
            slurm_err: "/home/user/logs/job_100002.slurm_err"
        },
        {
            job_id: 100003,
            command: "train.py --lr 1e-5 --model llama",
            group_name: "llama:sweep",
            depends_on: [],
            status: "COMPLETED",
            preamble: "#!/bin/bash\n#SBATCH --job-name=model-sweep\n#SBATCH --time=00:30:00\n#SBATCH --mem=2G",
            start_time: "2024-01-15 08:00:00",
            end_time: "2024-01-15 08:15:00",
            slurm_out: "/home/user/logs/job_100003.slurm_out",
            slurm_err: "/home/user/logs/job_100003.slurm_err"
        },
        {
            job_id: 100004,
            command: "train.py --lr 1e-3 --model gpt2",
            group_name: "gpt:sweep",
            depends_on: [],
            status: "COMPLETED",
            preamble: "#!/bin/bash\n#SBATCH --job-name=model-sweep\n#SBATCH --time=00:30:00\n#SBATCH --mem=2G",
            start_time: "2024-01-15 08:00:00",
            end_time: "2024-01-15 08:15:00",
            slurm_out: "/home/user/logs/job_100004.slurm_out",
            slurm_err: "/home/user/logs/job_100004.slurm_err"
        },
        {
            job_id: 100005,
            command: "train.py --lr 1e-4 --model gpt2",
            group_name: "gpt:sweep",
            depends_on: [],
            status: "COMPLETED",
            preamble: "#!/bin/bash\n#SBATCH --job-name=model-sweep\n#SBATCH --time=00:30:00\n#SBATCH --mem=2G",
            start_time: "2024-01-15 08:00:00",
            end_time: "2024-01-15 08:15:00",
            slurm_out: "/home/user/logs/job_100005.slurm_out",
            slurm_err: "/home/user/logs/job_100005.slurm_err"
        },
        {
            job_id: 100006,
            command: "train.py --lr 1e-5 --model gpt2",
            group_name: "gpt:sweep",
            depends_on: [],
            status: "COMPLETED",
            preamble: "#!/bin/bash\n#SBATCH --job-name=model-sweep\n#SBATCH --time=00:30:00\n#SBATCH --mem=2G",
            start_time: "2024-01-15 08:00:00",
            end_time: "2024-01-15 08:15:00",
            slurm_out: "/home/user/logs/job_100006.slurm_out",
            slurm_err: "/home/user/logs/job_100006.slurm_err"
        }, 
        {
            job_id: 200001,
            command: "python train.py --model llama --epochs 50 --batch_size 32",
            group_name: "llama:train_best",
            depends_on: ["100001", "100002", "100003"],
            status: "COMPLETED",
            preamble: "#!/bin/bash\n#SBATCH --job-name=train-llama\n#SBATCH --gres=gpu:2\n#SBATCH --time=04:00:00\n#SBATCH --mem=32G",
            start_time: "2024-01-15 08:30:00",
            end_time: "2024-01-15 12:15:00",
            slurm_out: "/home/user/logs/job_200001.slurm_out",
            slurm_err: "/home/user/logs/job_200001.slurm_err"
        },
        {
            job_id: 200002,
            command: "python eval.py --group_id 100001",
            group_name: "llama:train",
            depends_on: ["200001"],
            status: "COMPLETED",
            preamble: "#!/bin/bash\n#SBATCH --job-name=train-llama\n#SBATCH --gres=gpu:2\n#SBATCH --time=04:00:00\n#SBATCH --mem=32G",
            start_time: "2024-01-15 08:30:00",
            end_time: "2024-01-15 12:15:00",
            slurm_out: "/home/user/logs/job_200002.slurm_out",
            slurm_err: "/home/user/logs/job_200002.slurm_err"
        },
        {
            job_id: 200003,
            command: "python train.py --model gpt --epochs 50 --batch_size 16",
            group_name: "gpt:train_best",
            depends_on: ["100004", "100005", "100006"],
            status: "RUNNING",
            preamble: "#!/bin/bash\n#SBATCH --job-name=train-gpt\n#SBATCH --gres=gpu:4\n#SBATCH --time=06:00:00\n#SBATCH --mem=64G",
            start_time: "2024-01-15 08:30:00",
            slurm_out: "/home/user/logs/job_200003.slurm_out",
            slurm_err: "/home/user/logs/job_200003.slurm_err",
            stats: {
                gpu_memory_used_mb: 45056,
                gpu_memory_total_mb: 65536,
                gpu_count: 4,
                cpu_usage: 88
            }
        },
        {
            job_id: 200004,
            command: "python eval.py --group_id 100004",
            group_name: "gpt:train",
            depends_on: ["200003"],
            status: "RUNNING",
            preamble: "#!/bin/bash\n#SBATCH --job-name=train-gpt\n#SBATCH --gres=gpu:4\n#SBATCH --time=06:00:00\n#SBATCH --mem=64G",
            start_time: "2024-01-15 08:30:00",
            slurm_out: "/home/user/logs/job_200004.slurm_out",
            slurm_err: "/home/user/logs/job_200004.slurm_err",
            stats: {
                gpu_memory_used_mb: 45056,
                gpu_memory_total_mb: 65536,
                gpu_count: 4,
                cpu_usage: 88
            }
        },
        {
            job_id: 400001,
            command: "python plot.py --results eval_results/ --output plots/comparison.png",
            group_name: "plot",
            depends_on: ["200002", "200004"],
            status: "PENDING",
            preamble: "#!/bin/bash\n#SBATCH --job-name=plot-comparison\n#SBATCH --time=00:15:00\n#SBATCH --mem=4G",
            slurm_out: "/home/user/logs/job_400001.slurm_out",
            slurm_err: "/home/user/logs/job_400001.slurm_err"
        },
    ];

    // Global state
    let jobs = [];
    let allGroups = [];
    let filteredGroups = [];
    let cy = null;
    let isLoading = false;
    let librariesLoaded = false;
    let tooltip = null;

    // Log viewer state
    let logViewerState = {
        isOpen: false,
        currentJobId: null,
        currentLogPath: null,
        currentLogType: 'output',
        isTailing: false,
        autoScroll: false, // Changed from true to false
        tailInterval: null,
        lastLogLines: 0,
        logContent: ''
    };

    // Filter state
    let filters = {
        search: '',
        statuses: new Set(),
        groups: new Set(),
        dependencies: new Set()
    };

    // Function to load external libraries
    function loadLibraries() {
        return new Promise((resolve, reject) => {
            // Load Cytoscape.js
            const cytoscapeScript = document.createElement('script');
            cytoscapeScript.src = 'https://cdnjs.cloudflare.com/ajax/libs/cytoscape/3.26.0/cytoscape.min.js';
            cytoscapeScript.onload = () => {
                // Load Dagre layout extension
                const dagreScript = document.createElement('script');
                dagreScript.src = 'https://cdnjs.cloudflare.com/ajax/libs/dagre/0.8.5/dagre.min.js';
                dagreScript.onload = () => {
                    // Load Cytoscape-Dagre extension
                    const cytoscapeDagreScript = document.createElement('script');
                    cytoscapeDagreScript.src = 'https://cdn.jsdelivr.net/npm/cytoscape-dagre@2.5.0/cytoscape-dagre.js';
                    cytoscapeDagreScript.onload = () => {
                        librariesLoaded = true;
                        resolve();
                    };
                    cytoscapeDagreScript.onerror = reject;
                    document.head.appendChild(cytoscapeDagreScript);
                };
                dagreScript.onerror = reject;
                document.head.appendChild(dagreScript);
            };
            cytoscapeScript.onerror = reject;
            document.head.appendChild(cytoscapeScript);
        });
    }

    // Function to fetch jobs from API or return dummy data
    async function getJobs() {
        try {
            setLoading(true);
            hideError();
            
            // Uncomment these lines to enable API calls:
            const response = await fetch('/api/jobs');
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            const data = await response.json();
            console.log('Fetched jobs from API:', data);
            return data;

            // For development, simulate API delay and return dummy data
            await new Promise(resolve => setTimeout(resolve, 500));
            console.log('Using dummy data for development');
            return DUMMY_JOBS;
            
        } catch (error) {
            console.error('Error fetching jobs from API:', error);
            showError('Failed to load jobs from API. Using dummy data.');
            
            // Fallback to dummy data on error
            return DUMMY_JOBS;
        } finally {
            setLoading(false);
        }
    }

    // Log viewer functions
    async function openLogViewer(jobId, logPath, logType = 'output') {
        logViewerState.currentJobId = jobId;
        logViewerState.currentLogPath = logPath;
        logViewerState.currentLogType = logType;
        logViewerState.isOpen = true;
        logViewerState.logContent = '';
        logViewerState.lastLogSize = 0;

        // Update modal title with log type
        const logTypeLabel = logType === 'error' ? 'Error Log' : 'Output Log';
        document.getElementById('log-modal-title').textContent = `Job #${jobId} - ${logTypeLabel} (${logPath})`;
        
        // Clear log viewer
        const logViewer = document.getElementById('log-viewer');
        logViewer.value = '';
        
        // Show modal
        document.getElementById('log-modal').classList.add('show');
        
        // Update status
        updateLogStatus('connecting', 'Connecting...');
        
        // Load initial log content
        await loadLogContent();
    }

    // Replace the loadLogContent function
    async function loadLogContent() {
        try {
            const response = await fetch(`/api/logs/${logViewerState.currentJobId}?path=${encodeURIComponent(logViewerState.currentLogPath)}`);
            
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            
            const data = await response.json();
            logViewerState.logContent = data.content || '';
            logViewerState.lastLogLines = data.total_lines || 0;
            
            // Update log viewer
            const logViewer = document.getElementById('log-viewer');
            logViewer.value = logViewerState.logContent;
            
            // Auto scroll to bottom if enabled
            if (logViewerState.autoScroll) {
                logViewer.scrollTop = logViewer.scrollHeight;
            }
            
            // Update status and info
            updateLogStatus('connected', 'Connected');
            updateLogInfo();
            
        } catch (error) {
            console.error('Error loading log content:', error);
            
            // Fallback to demo content
            const demoContent = generateDemoLogContent(logViewerState.currentJobId, logViewerState.currentLogType);
            logViewerState.logContent = demoContent;
            
            const logViewer = document.getElementById('log-viewer');
            logViewer.value = demoContent;
            
            if (logViewerState.autoScroll) {
                logViewer.scrollTop = logViewer.scrollHeight;
            }
            
            updateLogStatus('error', 'Failed to connect - showing demo content');
            updateLogInfo();
        }
    }


    function generateDemoLogContent(jobId, logType = 'output') {
        const timestamp = new Date().toISOString();

        return `No logs for job #${jobId} available. This is a demo log content.`
        
        if (logType === 'error') {
            return `[${timestamp}] SLURM Error Log for Job #${jobId}
[${timestamp}] slurmstepd: error: *** JOB ${jobId} ON node001 CANCELLED AT ${timestamp} ***
[${timestamp}] srun: error: node001: task 0: Terminated
[${timestamp}] Python traceback (most recent call last):
[${timestamp}]   File "train.py", line 45, in <module>
[${timestamp}]     model = load_model(args.model_path)
[${timestamp}]   File "train.py", line 23, in load_model
[${timestamp}]     return torch.load(model_path)
[${timestamp}] FileNotFoundError: [Errno 2] No such file or directory: '/models/checkpoint_${jobId}.pt'
[${timestamp}] CUDA out of memory. Tried to allocate 2.00 GiB (GPU 0; 39.59 GiB total capacity)
[${timestamp}] slurmstepd: error: Detected 1 oom-kill event(s) in StepId=${jobId}.batch cgroup
[${timestamp}] Job ${jobId} exceeded memory limit and was terminated`;
        }
        
        // Return existing output log content for output type
        return `[${timestamp}] SLURM Job #${jobId} started
[${timestamp}] Loading environment...
[${timestamp}] Python 3.9.7 | packaged by conda-forge
[${timestamp}] CUDA Version: 11.8
[${timestamp}] GPU 0: NVIDIA A100-SXM4-40GB (UUID: GPU-12345678-1234-1234-1234-123456789abc)
[${timestamp}] Starting training script...
[${timestamp}] Loading dataset from /data/train.csv
[${timestamp}] Dataset loaded: 1,000,000 samples
[${timestamp}] Model architecture: Transformer (110M parameters)
[${timestamp}] Optimizer: AdamW (lr=1e-4, weight_decay=0.01)
[${timestamp}] Starting training loop...
[${timestamp}] Epoch 1/50 - Step 100/1000 - Loss: 2.345 - GPU Memory: 32GB/40GB
[${timestamp}] Epoch 1/50 - Step 200/1000 - Loss: 2.123 - GPU Memory: 32GB/40GB
[${timestamp}] Epoch 1/50 - Step 300/1000 - Loss: 1.987 - GPU Memory: 32GB/40GB
[${timestamp}] Epoch 1/50 - Step 400/1000 - Loss: 1.876 - GPU Memory: 32GB/40GB
[${timestamp}] Epoch 1/50 - Step 500/1000 - Loss: 1.765 - GPU Memory: 32GB/40GB
[${timestamp}] Checkpointing model at step 500...
[${timestamp}] Checkpoint saved to /checkpoints/model_step_500.pt
[${timestamp}] Epoch 1/50 - Step 600/1000 - Loss: 1.654 - GPU Memory: 32GB/40GB
[${timestamp}] Epoch 1/50 - Step 700/1000 - Loss: 1.543 - GPU Memory: 32GB/40GB
[${timestamp}] Epoch 1/50 - Step 800/1000 - Loss: 1.432 - GPU Memory: 32GB/40GB
[${timestamp}] Epoch 1/50 - Step 900/1000 - Loss: 1.321 - GPU Memory: 32GB/40GB
[${timestamp}] Epoch 1/50 - Step 1000/1000 - Loss: 1.210 - GPU Memory: 32GB/40GB
[${timestamp}] Epoch 1/50 completed - Average Loss: 1.654 - Time: 45m 23s
[${timestamp}] Validation Loss: 1.543 - Validation Accuracy: 67.8%
[${timestamp}] Starting Epoch 2/50...
[${timestamp}] Training in progress...`;
    }

    // Replace the tailLogFile function
    async function tailLogFile() {
        if (!logViewerState.isTailing || !logViewerState.isOpen) {
            return;
        }

        try {
            const response = await fetch(`/api/logs/${logViewerState.currentJobId}?path=${encodeURIComponent(logViewerState.currentLogPath)}&start=${logViewerState.lastLogLines}`);
            
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            
            const data = await response.json();
            
            if (data.content && data.content.length > 0) {
                logViewerState.logContent += data.content;
                logViewerState.lastLogLines = data.total_lines || logViewerState.lastLogLines;
                
                const logViewer = document.getElementById('log-viewer');
                logViewer.value = logViewerState.logContent;
                
                if (logViewerState.autoScroll) {
                    logViewer.scrollTop = logViewer.scrollHeight;
                }
                
                updateLogInfo();
            }
            
        } catch (error) {
            console.error('Error tailing log:', error);
            
            // Simulate new log lines for demo
            if (Math.random() > 0.7) { // 30% chance of new content
                const timestamp = new Date().toISOString();
                const step = Math.floor(Math.random() * 1000) + 1;
                const loss = (Math.random() * 2 + 0.5).toFixed(3);
                const newLine = `\n[${timestamp}] Epoch 2/50 - Step ${step}/1000 - Loss: ${loss} - GPU Memory: 32GB/40GB`;
                
                logViewerState.logContent += newLine;
                
                const logViewer = document.getElementById('log-viewer');
                logViewer.value = logViewerState.logContent;
                
                if (logViewerState.autoScroll) {
                    logViewer.scrollTop = logViewer.scrollHeight;
                }
                
                updateLogInfo();
            }
        }
    }

    function toggleTailing() {
        logViewerState.isTailing = !logViewerState.isTailing;
        logViewerState.autoScroll = logViewerState.isTailing; // Auto-scroll follows tailing state
        
        const tailBtn = document.getElementById('tail-toggle-btn');
        const tailText = tailBtn.querySelector('span:last-child');

        if (logViewerState.isTailing) {
            tailText.textContent = 'Tail: ON';
            tailBtn.classList.add('active');
            updateLogStatus('connected', 'Tailing active (auto-scroll enabled)');
            
            // Start tailing interval
            logViewerState.tailInterval = setInterval(tailLogFile, 2000);

            // Scroll to bottom immediately when enabling tail
            const logViewer = document.getElementById('log-viewer');
            logViewer.scrollTop = logViewer.scrollHeight;
        } else {
            tailText.textContent = 'Tail: OFF';
            tailBtn.classList.remove('active');
            updateLogStatus('connected', 'Connected');
            
            // Clear tailing interval
            if (logViewerState.tailInterval) {
                clearInterval(logViewerState.tailInterval);
                logViewerState.tailInterval = null;
            }
        }
    }

    function closeLogModal() {
        logViewerState.isOpen = false;
        logViewerState.isTailing = false;
        logViewerState.autoScroll = false; // Reset to false
        
        // Clear tailing interval
        if (logViewerState.tailInterval) {
            clearInterval(logViewerState.tailInterval);
            logViewerState.tailInterval = null;
        }
        
        // Reset buttons
        const tailBtn = document.getElementById('tail-toggle-btn');
        const tailText = tailBtn.querySelector('span:last-child');
        tailText.textContent = 'Tail: OFF';
        tailBtn.classList.remove('active');
        
        // Hide modal
        document.getElementById('log-modal').classList.remove('show');
        
        // Reset state
        logViewerState.currentJobId = null;
        logViewerState.currentLogPath = null;
        logViewerState.logContent = '';
        logViewerState.lastLogSize = 0;
    }

    function updateLogStatus(status, message) {
        const statusDot = document.getElementById('log-status-dot');
        const statusText = document.getElementById('log-status-text');
        
        statusDot.className = 'log-status-dot';
        
        switch (status) {
            case 'connected':
                statusDot.classList.add('connected');
                break;
            case 'error':
                statusDot.classList.add('error');
                break;
            default:
                break;
        }
        
        statusText.textContent = message;
    }

    function updateLogInfo() {
        const lines = logViewerState.logContent.split('\n').length;
        const bytes = new Blob([logViewerState.logContent]).size;
        
        document.getElementById('log-lines').textContent = `${lines} lines`;
        document.getElementById('log-size').textContent = `${formatBytes(bytes)}`;
    }

    function formatBytes(bytes) {
        if (bytes === 0) return '0 bytes';
        const k = 1024;
        const sizes = ['bytes', 'KB', 'MB', 'GB'];
        const i = Math.floor(Math.log(bytes) / Math.log(k));
        return parseFloat((bytes / Math.pow(k, i)).toFixed(1)) + ' ' + sizes[i];
    }

    // Loading and error state management
    function setLoading(loading) {
        isLoading = loading;
        const loadingEl = document.getElementById('loading');
        if (loading) {
            loadingEl.classList.add('show');
        } else {
            loadingEl.classList.remove('show');
        }
    }

    function showError(message) {
        const errorEl = document.getElementById('error');
        errorEl.textContent = message;
        errorEl.classList.add('show');
        
        // Auto-hide error after 5 seconds
        setTimeout(() => {
            hideError();
        }, 5000);
    }

    function hideError() {
        document.getElementById('error').classList.remove('show');
    }

    function hideFallback() {
        document.getElementById('fallback').classList.remove('show');
    }

    // Refresh jobs function
    async function refreshJobs() {
        if (isLoading) return;
        
        try {
            const newJobs = await getJobs();
            jobs = newJobs;
            allGroups = createGroups();
            initializeFilters();
            applyFilters();
            console.log('Jobs refreshed successfully');
        } catch (error) {
            console.error('Failed to refresh jobs:', error);
            showError('Failed to refresh jobs');
        }
    }

    // Initialize filter UI
    function initializeFilters() {
        // Populate group filters
        const groupFilters = document.getElementById('group-filters');
        const uniqueGroups = [...new Set(jobs.map(job => job.node_name))].sort();
        
        groupFilters.innerHTML = uniqueGroups.map(group => 
            `<div class="filter-chip" data-group="${group}" onclick="toggleGroupFilter('${group}')">${group}</div>`
        ).join('');
    }

    // Filter functions
    function toggleStatusFilter(status) {
        const chip = document.querySelector(`[data-status="${status}"]`);
        if (filters.statuses.has(status)) {
            filters.statuses.delete(status);
            chip.classList.remove('active');
        } else {
            filters.statuses.add(status);
            chip.classList.add('active');
        }
        applyFilters();
    }

    function toggleGroupFilter(group) {
        const chip = document.querySelector(`[data-group="${group}"]`);
        if (filters.groups.has(group)) {
            filters.groups.delete(group);
            chip.classList.remove('active');
        } else {
            filters.groups.add(group);
            chip.classList.add('active');
        }
        applyFilters();
    }

    function toggleDependencyFilter(type) {
        const chip = document.querySelector(`[data-dependency="${type}"]`);
        if (filters.dependencies.has(type)) {
            filters.dependencies.delete(type);
            chip.classList.remove('active');
        } else {
            filters.dependencies.add(type);
            chip.classList.add('active');
        }
        applyFilters();
    }

    function clearAllFilters() {
        // Clear search
        document.getElementById('search-input').value = '';
        filters.search = '';
        
        // Clear status filters
        filters.statuses.clear();
        document.querySelectorAll('[data-status]').forEach(chip => {
            chip.classList.remove('active');
        });
        
        // Clear group filters
        filters.groups.clear();
        document.querySelectorAll('[data-group]').forEach(chip => {
            chip.classList.remove('active');
        });
        
        // Clear dependency filters
        filters.dependencies.clear();
        document.querySelectorAll('[data-dependency]').forEach(chip => {
            chip.classList.remove('active');
        });
        
        applyFilters();
    }

    function applyFilters() {
        // Update search filter
        filters.search = document.getElementById('search-input').value.toLowerCase();
        
        // Filter groups
        filteredGroups = allGroups.filter(group => {
            // Search filter
            if (filters.search) {
                const searchMatch = group.jobs.some(job => 
                    job.id.toString().includes(filters.search) ||
                    job.command.toLowerCase().includes(filters.search) ||
                    job.node_name.toLowerCase().includes(filters.search)
                );
                if (!searchMatch) return false;
            }
            
            // Status filter
            if (filters.statuses.size > 0) {
                const hasMatchingStatus = group.jobs.some(job => 
                    filters.statuses.has(job.status)
                );
                if (!hasMatchingStatus) return false;
            }
            
            // Group filter
            if (filters.groups.size > 0) {
                const hasMatchingGroup = group.jobs.some(job => 
                    filters.groups.has(job.node_name)
                );
                if (!hasMatchingGroup) return false;
            }
            
            // Dependency filter
            if (filters.dependencies.size > 0) {
                let dependencyMatch = false;
                
                if (filters.dependencies.has('has-deps')) {
                    dependencyMatch = dependencyMatch || group.jobs.some(job => job.parents.length > 0);
                }
                
                if (filters.dependencies.has('no-deps')) {
                    dependencyMatch = dependencyMatch || group.jobs.some(job => job.parents.length === 0);
                }
                
                if (filters.dependencies.has('root')) {
                    dependencyMatch = dependencyMatch || group.jobs.every(job => job.parents.length === 0);
                }
                
                if (!dependencyMatch) return false;
            }
            
            return true;
        });
        
        // Update UI
        updateFilterStats();
        updateClearButton();
        
        // Re-render graph
        if (librariesLoaded) {
            renderGraph();
        } else {
            renderSimpleGraph();
        }
    }

    function updateFilterStats() {
        const totalJobs = jobs.length;
        const visibleJobs = filteredGroups.reduce((sum, group) => sum + group.jobs.length, 0);
        const filteredJobs = totalJobs - visibleJobs;
        
        document.getElementById('visible-groups').textContent = filteredGroups.length;
        document.getElementById('visible-jobs').textContent = visibleJobs;
        document.getElementById('filtered-jobs').textContent = filteredJobs;
        
        // Update graph info
        document.getElementById('graph-info').textContent = 
            `Showing ${filteredGroups.length} groups • ${visibleJobs} jobs`;
    }

    function updateClearButton() {
        const hasActiveFilters = 
            filters.search ||
            filters.statuses.size > 0 ||
            filters.groups.size > 0 ||
            filters.dependencies.size > 0;
        
        const clearBtn = document.getElementById('clear-filters-btn');
        clearBtn.disabled = !hasActiveFilters;
    }

    // Utility functions
    function getStatusColor(status) {
        switch (status.toLowerCase()) {
            case "running": return "#3b82f6";
            case "completed": return "#10b981";
            case "failed": return "#ef4444";
            case "pending": return "#f59e0b";
            case "mixed": return "#d97706";
            default: return "#6b7280";
        }
    }

    function getStatusClass(status) {
        return `status-${status.toLowerCase()}`;
    }

    function getStatusIcon(status) {
        return `icon-${status.toLowerCase()}`;
    }

    function formatDuration(startTime, endTime) {
        if (!startTime || !endTime) return "N/A";
        const start = new Date(startTime);
        const end = new Date(endTime);
        const diffMs = end - start;
        const diffMins = Math.floor(diffMs / 60000);
        const diffHours = Math.floor(diffMins / 60);
        const remainingMins = diffMins % 60;
        
        if (diffHours > 0) {
            return `${diffHours}h ${remainingMins}m`;
        }
        return `${diffMins}m`;
    }

    function formatTime(timeString) {
        if (!timeString) return "N/A";
        return new Date(timeString).toLocaleTimeString();
    }

    // Updated color logic based on new rules
    function getNodeColor(jobs) {
        const statuses = jobs.map(job => job.status);
        
        // Rule 3: Use active color (blue) if at least one job is running
        if (statuses.includes("RUNNING")) {
            return "RUNNING";
        }
        
        // Rule 1: Use failed color (red) only if ALL jobs have failed
        if (statuses.every(status => status === "FAILED")) {
            return "FAILED";
        }
        
        // Rule 2: Use pending color (orange) only if ALL jobs are pending
        if (statuses.every(status => status === "PENDING")) {
            return "PENDING";
        }
        
        // Rule 4: Otherwise use completed color (green)
        return "COMPLETED";
    }

    // Calculate progress: (completed + failed) / total
    function calculateProgress(jobs) {
        if (jobs.length === 0) return 0;
        
        const finishedJobs = jobs.filter(job => 
            job.status === "COMPLETED" || job.status === "FAILED"
        ).length;
        
        return Math.round((finishedJobs / jobs.length) * 100);
    }

    // Create node groups based on dependencies
    function createGroups() {
        const parentToChildMap = new Map();
        
        // Build parent-child relationships
        jobs.forEach(job => {
            const jobId = job.id.toString();
            job.parents.forEach(depId => {
                if (!parentToChildMap.has(depId)) {
                    parentToChildMap.set(depId, new Set());
                }
                parentToChildMap.get(depId).add(jobId);
            });
        });

        // Group jobs by dependency signature
        const groupMap = new Map();
        jobs.forEach(job => {
            const jobId = job.id.toString();
            const parents = new Set(job.parents);
            const children = parentToChildMap.get(jobId) || new Set();
            const nodeId = job.node_id

            const parentsKey = Array.from(parents).sort().join(",");
            const childrenKey = Array.from(children).sort().join(",");
            const signature =  nodeId ? nodeId : `${parentsKey}|${childrenKey}`;

            if (!groupMap.has(signature)) {
                groupMap.set(signature, []);
            }
            groupMap.get(signature).push(job);
        });

        // Convert to groups
        const groups = [];
        let groupIndex = 0;

        groupMap.forEach(groupJobs => {
            const progress = calculateProgress(groupJobs);
            const nodeColor = getNodeColor(groupJobs);
            
            groups.push({
                id: `group_${groupIndex++}`,
                jobs: groupJobs,
                parents: new Set(groupJobs[0].parents),
                children: parentToChildMap.get(groupJobs[0].id.toString()) || new Set(),
                progress: progress,
                nodeColor: nodeColor
            });
        });

        return groups;
    }

    // Smart range display for job IDs
    function smartRangeDisplay(jobIds) {
        const sorted = jobIds.sort((a, b) => a - b);
        
        if (sorted.length === 1) {
            return sorted[0].toString();
        } else if (sorted.length <= 3) {
            return sorted.join(", ");
        } else {
            const isContinuous = sorted.every((id, i) => i === 0 || id === sorted[i - 1] + 1);
            
            if (isContinuous) {
                return `${sorted[0]}-${sorted[sorted.length - 1]}`;
            } else {
                return `${sorted[0]}...${sorted[sorted.length - 1]}`;
            }
        }
    }

    // Get group status - returns MIXED if there are different statuses
    function getGroupStatus(jobs) {
        const statuses = [...new Set(jobs.map(job => job.status))];
        if (statuses.length === 1) {
            return statuses[0];
        }
        return "MIXED";
    }

    // Get status breakdown for simplified tooltips
    function getStatusBreakdown(jobs) {
        const counts = {
            COMPLETED: 0,
            RUNNING: 0,
            FAILED: 0,
            PENDING: 0
        };
        
        jobs.forEach(job => {
            counts[job.status] = (counts[job.status] || 0) + 1;
        });
        
        const parts = [];
        if (counts.COMPLETED > 0) parts.push(`${counts.COMPLETED} completed`);
        if (counts.RUNNING > 0) parts.push(`${counts.RUNNING} running`);
        if (counts.FAILED > 0) parts.push(`${counts.FAILED} failed`);
        if (counts.PENDING > 0) parts.push(`${counts.PENDING} pending`);
        
        return parts.join(' • ');
    }

    // Simplified tooltip function
    function showTooltip(event, group) {
        const tooltip = document.getElementById('tooltip');
        const jobIds = group.jobs.map(j => j.id);
        const displayText = smartRangeDisplay(jobIds);
        const breakdown = getStatusBreakdown(group.jobs);
        
        tooltip.innerHTML = `
            <div class="tooltip-header">Group #${displayText}</div>
            <div class="tooltip-breakdown">${breakdown}</div>
        `;
        
        // Position tooltip
        let left = event.clientX + 10;
        let top = event.clientY - 10;
        
        // Adjust if tooltip would go off screen
        if (left + 200 > window.innerWidth) {
            left = event.clientX - 210;
        }
        if (top + 60 > window.innerHeight) {
            top = event.clientY - 70;
        }
        
        tooltip.style.left = left + 'px';
        tooltip.style.top = top + 'px';
        tooltip.classList.add('show');
    }

    function hideTooltip() {
        document.getElementById('tooltip').classList.remove('show');
    }

    // Render the graph using Cytoscape.js (when libraries are loaded)
    function renderGraph() {
        if (filteredGroups.length === 0 || !librariesLoaded) {
            if (librariesLoaded) {
                // Show empty state
                const cyContainer = document.getElementById('cy');
                cyContainer.innerHTML = `
                    <div style="display: flex; align-items: center; justify-content: center; height: 100%; flex-direction: column; color: var(--text-secondary);">
                        <div style="font-size: 48px; margin-bottom: 16px;">🔍</div>
                        <div style="font-size: 18px; margin-bottom: 8px;">No jobs match your filters</div>
                        <div style="font-size: 14px;">Try adjusting your search or filter criteria</div>
                    </div>
                `;
            }
            return;
        }
        
        const themeColors = getThemeColors();
        
        // Prepare nodes and edges for Cytoscape
        const elements = [];
        
        // Add nodes
        filteredGroups.forEach(group => {
            const jobIds = group.jobs.map(j => j.id);
            const displayText = smartRangeDisplay(jobIds);
            const groupName = group.jobs[0].node_name || "root";
            const progress = group.progress;
            const nodeColor = group.nodeColor;
            
            // Get color based on new rules
            const backgroundColor = getStatusColor(nodeColor);
            const borderColor = getStatusColor(nodeColor);
            
            // Simple label like the original
            const label = `#${displayText}\n${groupName}\n${progress}% done`;
            
            elements.push({
                data: {
                    id: group.id,
                    label: label,
                    jobs: group.jobs,
                    displayText: displayText,
                    groupName: groupName,
                    progress: progress,
                    nodeColor: nodeColor,
                    backgroundColor: backgroundColor,
                    borderColor: borderColor
                }
            });
        });
        
        // Add edges (only between visible groups)
        filteredGroups.forEach(group => {
            Array.from(group.parents).forEach(parentId => {
                const parentGroup = filteredGroups.find(g => g.jobs.some(j => j.id.toString() === parentId));
                if (parentGroup && parentGroup.id !== group.id) {
                    elements.push({
                        data: {
                            id: `${parentGroup.id}-${group.id}`,
                            source: parentGroup.id,
                            target: group.id
                        }
                    });
                }
            });
        });

        // Initialize or update Cytoscape
        if (cy) {
            cy.destroy();
        }

        try {
            cy = cytoscape({
                container: document.getElementById('cy'),
                elements: elements,
                style: [
                    {
                        selector: 'node',
                        style: {
                            'background-color': function(ele) {
                                return ele.data('backgroundColor');
                            },
                            'background-opacity': 0.15,
                            'border-color': function(ele) {
                                return ele.data('borderColor');
                            },
                            'border-width': 2,
                            'border-opacity': 0.8,
                            'label': 'data(label)',
                            'text-valign': 'center',
                            'text-halign': 'center',
                            'font-size': '12px',
                            'font-weight': 'bold',
                            'color': themeColors.textPrimary,
                            'text-wrap': 'wrap',
                            'text-max-width': '140px',
                            'width': '160px',
                            'height': '60px',
                            'shape': 'round-rectangle',
                            'cursor': 'pointer'
                        }
                    },
                    {
                        selector: 'node:hover',
                        style: {
                            'border-width': 3,
                            'border-opacity': 1,
                            'background-opacity': 0.25
                        }
                    },
                    {
                        selector: 'edge',
                        style: {
                            'width': 2,
                            'line-color': themeColors.textSecondary,
                            'target-arrow-color': themeColors.textSecondary,
                            'target-arrow-shape': 'triangle',
                            'curve-style': 'bezier',
                            'control-point-step-size': 40,
                            'arrow-scale': 1.2
                        }
                    },
                    {
                        selector: 'edge:hover',
                        style: {
                            'width': 3,
                            'line-color': themeColors.textPrimary,
                            'target-arrow-color': themeColors.textPrimary
                        }
                    }
                ],
                layout: {
                    name: 'dagre',
                    rankDir: 'LR',
                    spacingFactor: 1.5,
                    nodeSep: 50,
                    rankSep: 100,
                    edgeSep: 10
                },
                userZoomingEnabled: true,
                userPanningEnabled: true,
                boxSelectionEnabled: false,
                selectionType: 'single',
                wheelSensitivity: 0.2
            });

            // Add event listeners
            cy.on('tap', 'node', function(evt) {
                const node = evt.target;
                const group = {
                    jobs: node.data('jobs'),
                    displayText: node.data('displayText'),
                    groupName: node.data('groupName')
                };
                showGroupDetails(group);
            });

            // Add hover event listeners for simplified tooltips
            cy.on('mouseover', 'node', function(evt) {
                const node = evt.target;
                const group = {
                    jobs: node.data('jobs'),
                    displayText: node.data('displayText'),
                    groupName: node.data('groupName')
                };
                showTooltip(evt.originalEvent, group);
            });

            cy.on('mouseout', 'node', function(evt) {
                hideTooltip();
            });

            // Hide tooltip when mouse moves over the graph container
            cy.on('mousemove', function(evt) {
                if (evt.target === cy) {
                    hideTooltip();
                }
            });

            // Fit the graph to the container
            cy.fit();
            
            hideFallback();
        } catch (error) {
            console.error('Error initializing Cytoscape:', error);
            renderSimpleGraph();
        }
    }

    // Fallback: Simple SVG graph (if Cytoscape fails to load)
    function renderSimpleGraph() {
        hideFallback();
        const cyContainer = document.getElementById('cy');
        
        if (filteredGroups.length === 0) {
            cyContainer.innerHTML = `
                <div style="display: flex; align-items: center; justify-content: center; height: 100%; flex-direction: column; color: var(--text-secondary);">
                    <div style="font-size: 48px; margin-bottom: 16px;">🔍</div>
                    <div style="font-size: 18px; margin-bottom: 8px;">No jobs match your filters</div>
                    <div style="font-size: 14px;">Try adjusting your search or filter criteria</div>
                </div>
            `;
            return;
        }
        
        cyContainer.innerHTML = `
            <div style="display: flex; align-items: center; justify-content: center; height: 100%; flex-direction: column; color: var(--text-secondary);">
                <div style="font-size: 18px; margin-bottom: 8px;">📊 Simple Graph View</div>
                <div style="font-size: 14px; margin-bottom: 16px;">External libraries couldn't load, showing basic view</div>
                <div style="display: grid; gap: 12px; max-width: 600px; max-height: 400px; overflow-y: auto;">
                    ${filteredGroups.map(group => {
                        const jobIds = group.jobs.map(j => j.id);
                        const displayText = smartRangeDisplay(jobIds);
                        const groupName = group.jobs[0].node_name;
                        const progress = group.progress;
                        return `
                            <div style="border: 1px solid var(--border-primary); border-radius: 8px; padding: 12px; background: var(--bg-secondary); cursor: pointer;" onclick="showGroupDetails({jobs: ${JSON.stringify(group.jobs).replace(/"/g, '&quot;')}, displayText: '${displayText}', groupName: '${groupName}'})">
                                <div style="font-weight: bold; margin-bottom: 4px; color: var(--text-primary);">#${displayText} - ${groupName}</div>
                                <div style="font-size: 12px; color: var(--text-secondary);">${progress}% complete • ${group.jobs.length} jobs</div>
                                <div style="font-size: 11px; color: var(--text-tertiary); margin-top: 4px;">${getStatusBreakdown(group.jobs)}</div>
                            </div>
                        `;
                    }).join('')}
                </div>
            </div>
        `;
    }

    // Graph control functions
    function fitGraph() {
        if (cy) {
            cy.fit();
        }
    }

    function zoomIn() {
        if (cy) {
            cy.zoom(cy.zoom() * 1.2);
        }
    }

    function zoomOut() {
        if (cy) {
            cy.zoom(cy.zoom() * 0.8);
        }
    }

    function resetView() {
        if (cy) {
            cy.fit();
            cy.center();
        }
    }

    // Enhanced modal for group details
    function showGroupDetails(group) {
        const groupStatus = getGroupStatus(group.jobs);
        
        // Update modal header
        document.getElementById('modal-title').textContent = `Group: ${group.displayText}`;
        
        const completedJobs = group.jobs.filter(j => j.status === "COMPLETED").length;
        const runningJobs = group.jobs.filter(j => j.status === "RUNNING").length;
        const failedJobs = group.jobs.filter(j => j.status === "FAILED").length;
        const pendingJobs = group.jobs.filter(j => j.status === "PENDING").length;
        
        document.getElementById('modal-subtitle').innerHTML = `
            <span>${group.groupName}</span>
            <span>•</span>
            <span>${group.jobs.length} jobs</span>
            <span>•</span>
            <span class="status-${groupStatus.toLowerCase()}">${groupStatus}</span>
        `;
        
        document.getElementById('modal-stats').innerHTML = `
            <div class="stat-item">
                <span class="stat-value">${completedJobs}</span>
                <span>completed</span>
            </div>
            <div class="stat-item">
                <span class="stat-value">${runningJobs}</span>
                <span>running</span>
            </div>
            <div class="stat-item">
                <span class="stat-value">${failedJobs}</span>
                <span>failed</span>
            </div>
            <div class="stat-item">
                <span class="stat-value">${pendingJobs}</span>
                <span>pending</span>
            </div>
        `;
        
        // Update modal body
        const jobGrid = document.getElementById('job-grid');
        jobGrid.innerHTML = '';
        
        group.jobs.forEach(job => {
            const jobCard = document.createElement('div');
            jobCard.className = 'job-card';
            
            let resourceInfo = '';
            if (job.status === "RUNNING" && job.stats) {
                const gpuUsage = (job.stats.gpu_memory_used_mb / job.stats.gpu_memory_total_mb) * 100;
                resourceInfo = `
                    <div class="resource-info">
                        <div class="resource-item">
                            <span class="resource-label">GPU Memory</span>
                            <span class="resource-value">${job.stats.gpu_memory_used_mb}MB / ${job.stats.gpu_memory_total_mb}MB</span>
                        </div>
                        <div class="progress-bar">
                            <div class="progress-fill" style="width: ${gpuUsage}%"></div>
                        </div>
                        <div class="resource-item">
                            <span class="resource-label">GPU Count</span>
                            <span class="resource-value">${job.stats.gpu_count}</span>
                        </div>
                        <div class="resource-item">
                            <span class="resource-label">CPU Usage</span>
                            <span class="resource-value">${job.stats.cpu_usage}%</span>
                        </div>
                    </div>
                `;
            }
            
            let errorInfo = '';
            if (job.status === "FAILED" && job.error_message) {
                errorInfo = `
                    <div class="resource-info error-info">
                        <div class="resource-item">
                            <span class="resource-label">Error</span>
                            <span class="resource-value">${job.error_message}</span>
                        </div>
                    </div>
                `;
            }

            // Add log viewer buttons if slurm files exist
            let logViewerButtons = '';
            if (job.slurm_out || job.slurm_err) {
                logViewerButtons = '<div class="log-buttons">';
                
                if (job.slurm_out) {
                    logViewerButtons += `
                        <button class="log-viewer-btn output-log" onclick="openLogViewer(${job.id}, '${job.slurm_out}', 'output')">
                            📄 Output Log
                        </button>
                    `;
                }
                
                if (job.slurm_err) {
                    logViewerButtons += `
                        <button class="log-viewer-btn error-log" onclick="openLogViewer(${job.id}, '${job.slurm_err}', 'error')">
                            ⚠️ Error Log
                        </button>
                    `;
                }
                
                logViewerButtons += '</div>';
            }
            
            jobCard.innerHTML = `
                <div class="job-header">
                    <div class="job-id">#${job.id}</div>
                    <div class="job-status ${getStatusClass(job.status)}">
                        <span class="status-icon ${getStatusIcon(job.status)}"></span>
                        ${job.status}
                    </div>
                </div>
                
                <div class="job-command">${job.command}</div>
                
                <div class="job-details">
                    <div class="job-detail-item">
                        <div class="job-detail-label">Dependencies</div>
                        <div class="job-detail-value">
                            ${job.depends_on && job.depends_on.length > 0 ? 
                                `<div class="dependency-list">
                                    ${job.depends_on.map(dep => `<span class="dependency-tag">#${dep}</span>`).join('')}
                                </div>` :
                                'None'
                            }
                        </div>
                    </div>
                    
                    <div class="job-detail-item">
                        <div class="job-detail-label">Duration</div>
                        <div class="job-detail-value">${formatDuration(job.start_time, job.end_time)}</div>
                    </div>
                    
                    <div class="job-detail-item">
                        <div class="job-detail-label">Start Time</div>
                        <div class="job-detail-value">${formatTime(job.start_time)}</div>
                    </div>
                    
                    <div class="job-detail-item">
                        <div class="job-detail-label">End Time</div>
                        <div class="job-detail-value">${formatTime(job.end_time)}</div>
                    </div>
                </div>
                
                ${resourceInfo}
                ${errorInfo}
                ${logViewerButtons}
            `;
            
            jobGrid.appendChild(jobCard);
        });
        
        // Show modal
        document.getElementById('modal').classList.add('show');
    }

    function closeModal() {
        document.getElementById('modal').classList.remove('show');
    }

    // Close modal when clicking outside
    document.getElementById('modal').addEventListener('click', (e) => {
        if (e.target.id === 'modal') {
            closeModal();
        }
    });

    // Close log modal when clicking outside
    document.getElementById('log-modal').addEventListener('click', (e) => {
        if (e.target.id === 'log-modal') {
            closeLogModal();
        }
    });

    // Hide tooltip when clicking anywhere
    document.addEventListener('click', () => {
        hideTooltip();
    });

    // Initialize the application
    async function init() {
        try {
            // Initialize theme first
            initTheme();
            
            // Try to load external libraries
            try {
                await loadLibraries();
                console.log('External libraries loaded successfully');
            } catch (error) {
                console.warn('Failed to load external libraries, using fallback:', error);
                librariesLoaded = false;
            }

            // Load job data
            jobs = await getJobs();
            allGroups = createGroups();
            filteredGroups = [...allGroups]; // Initially show all groups
            
            // Initialize filters
            initializeFilters();
            updateFilterStats();
            updateClearButton();
            
            // Render graph
            if (librariesLoaded) {
                renderGraph();
            } else {
                renderSimpleGraph();
            }
            
            console.log('Application initialized successfully');
            
        } catch (error) {
            console.error('Failed to initialize:', error);
            showError('Failed to initialize application');
            hideFallback();
            
            // Show basic fallback
            const cyContainer = document.getElementById('cy');
            cyContainer.innerHTML = `
                <div style="display: flex; align-items: center; justify-content: center; height: 100%; color: var(--error-text);">
                    <div>Failed to initialize application. Please refresh the page.</div>
                </div>
            `;
        }
    }

    // Start the application
    init();
</script>
</body>
</html>
